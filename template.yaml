AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Routes ec2 events from Cloudtrail logs groups to a lambda functions
Resources:
  LogRouter:
    Type: AWS::Serverless::Function
    Properties:
      InlineCode: |
        var zlib = require('zlib')
        exports.handler = function(event) {
        console.log(event)
        if (event.awslogs && event.awslogs.data) {
        const payload = Buffer.from(event.awslogs.data, 'base64')
        const logevents = JSON.parse(zlib.unzipSync(payload).toString()).logEvents
        for (const logevent of logevents) {
          const log = JSON.parse(logevent.message)
          console.log(log)
          }
        }
        }
      Handler: index.handler
      Runtime: nodejs12.x
  LogRouterCloudWatchPermission:
    Type: AWS::Lambda::Permission
    Properties:
      Action: "lambda:*"
      FunctionName:
        Ref: LogRouter
      Principal: logs.ap-southeast-1.amazonaws.com
  CloudtrailSubscription:
    Type: AWS::Logs::SubscriptionFilter
    DependsOn: LogRouterCloudWatchPermission
    Properties:
      DestinationArn:
        "Fn::GetAtt": [LogRouter, Arn]
      FilterPattern: "{ $.eventName = \"RunInstances\" }"
      LogGroupName: CloudTrail/DefaultLogGroup
